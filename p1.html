<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나들이(전국)</title>
    <style>
        body {
            font-family: sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        table {
            border-collapse: collapse;
            width: 80%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px; /* 약간 줄임 */
            text-align: left;
            height: 60px; /* 약간 줄임 */
            vertical-align: top;
            font-size: 12px; /* 약간 줄임 */
        }
        th {
            background-color: #f0f0f0;
            text-align: center;
        }
        .event {
            background-color: #e0f7fa;
            padding: 3px; /* 더 줄임 */
            margin-bottom: 2px; /* 더 줄임 */
            border-radius: 3px;
            cursor: pointer;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 95%;
            font-size: 11px; /* 더 줄임 */
        }
        .today {
            background-color: #ffe0b2;
        }
        .day-number {
            text-align: center;
            margin-bottom: 3px; /* 더 줄임 */
            font-weight: bold;
            font-size: 12px; /* 더 줄임 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <select id="month-select">
                <option value="1">1월</option>
                <option value="2">2월</option>
                <option value="3">3월</option>
                <option value="4" selected>4월</option>
                <option value="5">5월</option>
                <option value="6">6월</option>
                <option value="7">7월</option>
                <option value="8">8월</option>
                <option value="9">9월</option>
                <option value="10">10월</option>
                <option value="11">11월</option>
                <option value="12">12월</option>
            </select>
            <select id="region-select">
                <option value="전국">전국</option>
                <option value="서울">서울</option>
                <option value="부산">부산</option>
                <option value="대구">대구</option>
                <option value="인천" selected>인천</option>
                <option value="광주">광주</option>
                <option value="대전">대전</option>
                <option value="울산">울산</option>
                <option value="세종">세종</option>
                <option value="경기">경기</option>
                <option value="강원">강원</option>
                <option value="충북">충북</option>
                <option value="충남">충남</option>
                <option value="전북">전북</option>
                <option value="전남">전남</option>
                <option value="경북">경북</option>
                <option value="경남">경남</option>
                <option value="제주">제주</option>
            </select>
            <button onclick="loadCalendar()">달력 보기</button>
        </div>
        <div id="calendar"></div>
    </div>

    <script>
        const today = new Date();
        let currentMonth = today.getMonth() + 1;
        let currentYear = today.getFullYear();
        const monthSelect = document.getElementById('month-select');
        const regionSelect = document.getElementById('region-select');
        const calendarDiv = document.getElementById('calendar');

        // 초기 월 설정 (현재 월로 되어 있지만, 예시 데이터가 4월이라 4월로 임시 설정)
        monthSelect.value = 4;

        function loadCalendar() {
            const selectedMonth = parseInt(monthSelect.value);
            const selectedRegion = regionSelect.value;

            fetch('p1.csv')
                .then(response => response.text())
                .then(csvData => {
                    const events = parseCSV(csvData);
                    renderCalendar(currentYear, selectedMonth, events, selectedRegion);
                });
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (headers.length === values.length) { // 데이터 누락 방지
                    const entry = {};
                    headers.forEach((header, index) => {
                        entry[header] = values[index].trim(); // 공백 제거
                    });
                    data.push(entry);
                }
            }
            return data;
        }

        function renderCalendar(year, month, events, region) {
            calendarDiv.innerHTML = '';

            const firstDayOfMonth = new Date(year, month - 1, 1);
            const lastDayOfMonth = new Date(year, month, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay();

            const calendarTable = document.createElement('table');
            const headerRow = document.createElement('tr');
            const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
            daysOfWeek.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            });
            calendarTable.appendChild(headerRow);

            let dayCounter = 1;
            for (let i = 0; i < 6; i++) {
                const weekRow = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const dayCell = document.createElement('td');
                    if (i === 0 && j < firstDayOfWeek) {
                        // 이전 달의 빈 칸
                    } else if (dayCounter > daysInMonth) {
                        // 다음 달의 빈 칸
                    } else {
                        const currentDate = new Date(year, month - 1, dayCounter);
                        dayCell.innerHTML = `<div class="day-number">${dayCounter}</div>`;
                        if (currentDate.toDateString() === today.toDateString()) {
                            dayCell.classList.add('today');
                        }

                        // 해당 날짜의 이벤트 필터링 (시작 날짜와 종료 날짜 모두 고려)
                        const dailyEvents = events.filter(event => {
                            const startDate = new Date(event['시작날짜']);
                            const endDate = event['종료날짜'] ? new Date(event['종료날짜']) : startDate;
                            const eventRegion = event['지역'].trim(); // 공백 제거

                            const isSameOrAfterStart = currentDate >= startDate;
                            const isSameOrBeforeEnd = currentDate <= endDate;
                            const isMatchingRegion = region === '전국' || eventRegion === region;

                            return isSameOrAfterStart && isSameOrBeforeEnd && isMatchingRegion;
                        });

                        dailyEvents.forEach(event => {
                            const eventLink = document.createElement('a');
                            eventLink.href = '#';
                            eventLink.classList.add('event');
                            const title = event['행사제목'].trim(); // 공백 제거
                            eventLink.textContent = title.length > 12 ? title.substring(0, 12) + '...' : title;
                            eventLink.addEventListener('click', () => openEventDetails(event));
                            dayCell.appendChild(eventLink);
                        });

                        dayCounter++;
                    }
                    weekRow.appendChild(dayCell);
                }
                calendarTable.appendChild(weekRow);
                if (dayCounter > daysInMonth) {
                    break;
                }
            }

            calendarDiv.appendChild(calendarTable);
        }

        function openEventDetails(event) {
            const details = `
                <h2>${event['행사제목']}</h2>
                <p><b>지역:</b> ${event['지역']}</p>
                <p><b>유형:</b> ${event['유형']}</p>
                <p><b>시작 날짜:</b> ${event['시작날짜']}</p>
                ${event['종료날짜'] ? `<p><b>종료 날짜:</b> ${event['종료날짜']}</p>` : ''}
                ${event['시작시간'] ? `<p><b>시작 시간:</b> ${event['시작시간']}</p>` : ''}
                ${event['종료시간'] ? `<p><b>종료 시간:</b> ${event['종료시간']}</p>` : ''}
                <p><b>장소:</b> ${event['장소']}</p>
                ${event['대상'] ? `<p><b>대상:</b> ${event['대상']}</p>` : ''}
                ${event['기관'] ? `<p><b>기관:</b> ${event['기관']}</p>` : ''}
                ${event['연락처'] ? `<p><b>연락처:</b> ${event['연락처']}</p>` : ''}
                <p><b>내용:</b> ${event['행사내용']}</p>
            `;
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${event['행사제목']}</title>
                </head>
                <body>
                    ${details}
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        // 초기 달력 로드
        loadCalendar();
    </script>
</body>
</html>