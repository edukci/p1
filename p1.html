<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>월별 행사 달력</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 5px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .month-selector {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        select {
            padding: 8px;
            margin: 0 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .calendar th {
            background-color: #f0f0f0;
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .calendar td {
            border: 1px solid #ddd;
            height: 120px;
            vertical-align: top;
            padding: 5px;
            position: relative;
            width: 14.28%;
            overflow: hidden;
        }
        .date {
            font-weight: bold;
            margin-bottom: 5px;
            text-align: right;
        }
        .event {
            background-color: #e6f7ff;
            border-radius: 3px;
            padding: 3px 5px;
            margin-bottom: 3px;
            font-size: 0.9em;
            cursor: pointer;
            border-left: 3px solid #1890ff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-container {
            max-height: 90px;
            overflow-y: auto;
        }
        .weekend {
            background-color: #f9f9f9;
        }
        .sunday {
            color: #e74c3c;
        }
        .saturday {
            color: #3498db;
        }
        .today {
            background-color: #ffffcc;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .event-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .event-detail {
            margin-bottom: 5px;
        }
        .event-label {
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
        }
        .file-input {
            display: none;
        }
        .file-label {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px 0;
        }
        .file-label:hover {
            background-color: #0b7dda;
        }
        .empty-message {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
        }
        .more-indicator {
            font-size: 0.8em;
            color: #666;
            text-align: center;
        }
        .stats {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            font-size: 0.9em;
            color: #666;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .event-type-공연 { border-left-color: #ff9800; background-color: #fff3e0; }
        .event-type-전시 { border-left-color: #2196F3; background-color: #e3f2fd; }
        .event-type-체험 { border-left-color: #4CAF50; background-color: #e8f5e9; }
        .event-type-교육 { border-left-color: #9C27B0; background-color: #f3e5f5; }
        .event-type-행사 { border-left-color: #F44336; background-color: #ffebee; }
        .debug-section {
            background-color: #f1f1f1;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }
        .show-debug {
            background-color: #757575;
            color: white;
        }
        #loadFromUrl {
            background-color: #9c27b0;
        }
        #loadFromUrl:hover {
            background-color: #7b1fa2;
        }
        .csv-url-input {
            display: none;
            margin-top: 10px;
        }
        #csvUrlInput {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .column-mapper {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
        .column-mapping-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .column-mapping-label {
            width: 120px;
            font-weight: bold;
        }
        .column-mapping-select {
            flex-grow: 1;
            padding: 5px;
        }
        .highlight-button {
            background-color: #ff9800;
        }
        .highlight-button:hover {
            background-color: #f57c00;
        }
        .filter-section {
            display: flex;
            align-items: center;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            flex-grow: 1;
            min-width: 200px;
            max-width: 300px;
        }
        .filter-label {
            margin-right: 5px;
            font-weight: bold;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .month-selector {
                justify-content: center;
                margin-bottom: 10px;
            }
            .calendar {
                font-size: 0.9em;
            }
            .calendar td {
                height: 80px;
                padding: 2px;
            }
            .event {
                padding: 2px;
                font-size: 0.8em;
            }
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>월별 행사 달력</h1>
        
        <div class="controls">
            <div>
                <label for="fileInput" class="file-label">CSV 파일 선택</label>
                <input type="file" id="fileInput" class="file-input" accept=".csv">
                <span id="fileName"></span>
                <button id="loadFromUrl">URL로 불러오기</button>
                <div class="csv-url-input" id="csvUrlContainer">
                    <input type="text" id="csvUrlInput" placeholder="CSV 파일 URL을 입력하세요">
                    <button id="loadUrlButton">로드</button>
                </div>
            </div>
            
            <div class="month-selector">
                <select id="yearSelect"></select>
                <select id="monthSelect">
                    <option value="1">1월</option>
                    <option value="2">2월</option>
                    <option value="3">3월</option>
                    <option value="4">4월</option>
                    <option value="5">5월</option>
                    <option value="6">6월</option>
                    <option value="7">7월</option>
                    <option value="8">8월</option>
                    <option value="9">9월</option>
                    <option value="10">10월</option>
                    <option value="11">11월</option>
                    <option value="12">12월</option>
                </select>
                <button id="goToToday">오늘</button>
                <button id="toggleDebug" class="show-debug">디버그 정보</button>
            </div>
        </div>
        
        <div class="filter-section">
            <span class="filter-label">필터:</span>
            <input type="text" id="filterInput" class="filter-input" placeholder="행사명, 장소, 유형 등으로 검색">
            <button id="applyFilter">적용</button>
            <button id="clearFilter">초기화</button>
        </div>
        
        <div id="columnMapperContainer" class="column-mapper">
            <h3>열 매핑 설정</h3>
            <p>CSV 파일의 열이 프로그램에서 필요로 하는 필드와 일치하지 않는 경우, 아래에서 매핑을 설정하세요.</p>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">시작날짜:</span>
                <select id="startDateColumn" class="column-mapping-select"></select>
            </div>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">종료날짜:</span>
                <select id="endDateColumn" class="column-mapping-select"></select>
            </div>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">행사제목:</span>
                <select id="titleColumn" class="column-mapping-select"></select>
            </div>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">행사내용:</span>
                <select id="contentColumn" class="column-mapping-select"></select>
            </div>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">장소:</span>
                <select id="locationColumn" class="column-mapping-select"></select>
            </div>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">유형:</span>
                <select id="typeColumn" class="column-mapping-select"></select>
            </div>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">시작시간:</span>
                <select id="startTimeColumn" class="column-mapping-select"></select>
            </div>
            
            <div class="column-mapping-row">
                <span class="column-mapping-label">종료시간:</span>
                <select id="endTimeColumn" class="column-mapping-select"></select>
            </div>
            
            <button id="applyMapping" class="highlight-button">매핑 적용</button>
        </div>
        
        <div id="calendarContainer"></div>
        
        <div id="stats" class="stats">
            CSV 파일을 불러오는 중...
        </div>
        
        <div id="debugSection" class="debug-section">
            <h3>디버그 정보</h3>
            <div id="debugInfo"></div>
            <button id="downloadDebug">디버그 정보 다운로드</button>
        </div>
    </div>
    
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="eventDetails"></div>
        </div>
    </div>
    
    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="spinner"></div>
    </div>
    
    <script>
        // 전역 변수
        let rawCSVData = null;         // 원본 CSV 데이터
        let eventsData = [];           // 처리된 이벤트 데이터
        let filteredEvents = [];       // 필터링된 이벤트 데이터
        let totalRows = 0;             // 총 행 수
        let successfulRows = 0;        // 성공적으로 처리된 행 수
        let failedRows = 0;            // 처리 실패한 행 수
        let limitations = [];          // 제한 사항 메시지
        let debugMessages = [];        // 디버그 메시지
        let columnHeaders = [];        // CSV 파일의 열 이름 배열
        let currentFilter = "";        // 현재 적용된 필터
        
        // 기본 열 매핑 (기본값)
        let columnMapping = {
            startDate: "시작날짜",
            endDate: "종료날짜",
            title: "행사제목",
            content: "행사내용",
            location: "장소",
            type: "유형",
            startTime: "시작시간",
            endTime: "종료시간",
            target: "대상",
            organization: "기관",
            contact: "연락처"
        };
        
        // DOM 요소 참조
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const goToTodayBtn = document.getElementById('goToToday');
        const calendarContainer = document.getElementById('calendarContainer');
        const statsElement = document.getElementById('stats');
        const eventModal = document.getElementById('eventModal');
        const eventDetails = document.getElementById('eventDetails');
        const closeModalBtn = document.querySelector('.close');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const toggleDebugBtn = document.getElementById('toggleDebug');
        const debugSection = document.getElementById('debugSection');
        const debugInfo = document.getElementById('debugInfo');
        const downloadDebugBtn = document.getElementById('downloadDebug');
        const loadFromUrlBtn = document.getElementById('loadFromUrl');
        const csvUrlContainer = document.getElementById('csvUrlContainer');
        const csvUrlInput = document.getElementById('csvUrlInput');
        const loadUrlButton = document.getElementById('loadUrlButton');
        const columnMapperContainer = document.getElementById('columnMapperContainer');
        const startDateColumn = document.getElementById('startDateColumn');
        const endDateColumn = document.getElementById('endDateColumn');
        const titleColumn = document.getElementById('titleColumn');
        const contentColumn = document.getElementById('contentColumn');
        const locationColumn = document.getElementById('locationColumn');
        const typeColumn = document.getElementById('typeColumn');
        const startTimeColumn = document.getElementById('startTimeColumn');
        const endTimeColumn = document.getElementById('endTimeColumn');
        const applyMappingBtn = document.getElementById('applyMapping');
        const filterInput = document.getElementById('filterInput');
        const applyFilterBtn = document.getElementById('applyFilter');
        const clearFilterBtn = document.getElementById('clearFilter');
        
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            populateYearOptions();
            setCurrentMonth();
            renderCalendar();
            
            // 이벤트 리스너 등록
            yearSelect.addEventListener('change', renderCalendar);
            monthSelect.addEventListener('change', renderCalendar);
            
            goToTodayBtn.addEventListener('click', function() {
                const now = new Date();
                yearSelect.value = now.getFullYear();
                monthSelect.value = now.getMonth() + 1;
                renderCalendar();
            });
            
            closeModalBtn.addEventListener('click', function() {
                eventModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === eventModal) {
                    eventModal.style.display = 'none';
                }
            });
            
            // GitHub 환경에서 p1.csv 파일 자동 로드
            loadCSVFile('./p1.csv');
        });
        
        // 디버그 메시지 추가 함수
        function addDebugMessage(message) {
            const timestamp = new Date().toISOString();
            debugMessages.push(`[${timestamp}] ${message}`);
            updateDebugInfo();
        }
        
        // 디버그 정보 업데이트
        function updateDebugInfo() {
            if (debugMessages.length > 100) {
                debugMessages = debugMessages.slice(-100); // 최대 100개만 유지
            }
            debugInfo.innerHTML = debugMessages.join('<br>');
        }
        
        // 디버그 토글
        toggleDebugBtn.addEventListener('click', function() {
            if (debugSection.style.display === 'none' || debugSection.style.display === '') {
                debugSection.style.display = 'block';
                updateDebugInfo();
            } else {
                debugSection.style.display = 'none';
            }
        });
        
        // 디버그 정보 다운로드
        downloadDebugBtn.addEventListener('click', function() {
            const debugText = debugMessages.join('\n');
            const blob = new Blob([debugText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'calendar_debug.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // URL로 불러오기 토글
        loadFromUrlBtn.addEventListener('click', function() {
            if (csvUrlContainer.style.display === 'none' || csvUrlContainer.style.display === '') {
                csvUrlContainer.style.display = 'block';
                csvUrlInput.focus();
            } else {
                csvUrlContainer.style.display = 'none';
            }
        });
        
        // URL로 CSV 불러오기
        loadUrlButton.addEventListener('click', function() {
            const url = csvUrlInput.value.trim();
            if (url) {
                loadCSVFromURL(url);
            } else {
                alert('URL을 입력해주세요.');
            }
        });
        
        // URL에서 CSV 로드
        function loadCSVFromURL(url) {
            showLoading(true);
            addDebugMessage(`URL에서 CSV 로드 시도: ${url}`);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답이 올바르지 않습니다');
                    }
                    return response.text();
                })
                .then(csvText => {
                    processCSVData(csvText);
                    fileName.textContent = url.split('/').pop() || 'URL에서 로드됨';
                })
                .catch(error => {
                    showLoading(false);
                    addDebugMessage(`URL 로드 오류: ${error.message}`);
                    alert(`CSV 파일을 불러오는데 실패했습니다: ${error.message}`);
                });
        }
        
        // 년도 선택 옵션 채우기 (현재 년도 ±10년)
        function populateYearOptions() {
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 10; year <= currentYear + 10; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '년';
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear;
        }
        
        // 현재 월로 설정
        function setCurrentMonth() {
            const now = new Date();
            monthSelect.value = now.getMonth() + 1;
        }
        
        // 열 매핑 UI 업데이트
        function updateColumnMappingUI() {
            if (!columnHeaders || columnHeaders.length === 0) {
                columnMapperContainer.style.display = 'none';
                return;
            }
            
            // 모든 선택 상자 초기화 및 옵션 채우기
            [startDateColumn, endDateColumn, titleColumn, contentColumn, 
             locationColumn, typeColumn, startTimeColumn, endTimeColumn].forEach(select => {
                select.innerHTML = '';
                
                // 비어있음 옵션 추가
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '(없음)';
                select.appendChild(emptyOption);
                
                // 모든 헤더 옵션 추가
                columnHeaders.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
            });
            
            // 현재 매핑 설정
            startDateColumn.value = columnMapping.startDate || '';
            endDateColumn.value = columnMapping.endDate || '';
            titleColumn.value = columnMapping.title || '';
            contentColumn.value = columnMapping.content || '';
            locationColumn.value = columnMapping.location || '';
            typeColumn.value = columnMapping.type || '';
            startTimeColumn.value = columnMapping.startTime || '';
            endTimeColumn.value = columnMapping.endTime || '';
            
            // 매핑 UI 표시
            columnMapperContainer.style.display = 'block';
        }
        
        // 매핑 적용 버튼 이벤트
        applyMappingBtn.addEventListener('click', function() {
            // 새 매핑 저장
            columnMapping = {
                startDate: startDateColumn.value,
                endDate: endDateColumn.value,
                title: titleColumn.value,
                content: contentColumn.value,
                location: locationColumn.value,
                type: typeColumn.value,
                startTime: startTimeColumn.value,
                endTime: endTimeColumn.value,
                target: columnMapping.target,
                organization: columnMapping.organization,
                contact: columnMapping.contact
            };
            
            addDebugMessage("새 열 매핑 적용: " + JSON.stringify(columnMapping));
            
            // 원본 CSV 데이터 재처리
            if (rawCSVData) {
                processEventsData(rawCSVData);
                updateStats();
                applyFilter();
                renderCalendar();
            }
        });
        
        // 필터 적용 버튼
        applyFilterBtn.addEventListener('click', function() {
            applyFilter();
        });
        
        // 필터 초기화 버튼
        clearFilterBtn.addEventListener('click', function() {
            filterInput.value = '';
            currentFilter = '';
            applyFilter();
        });
        
        // 필터 적용 함수
        function applyFilter() {
            currentFilter = filterInput.value.trim().toLowerCase();
            
            if (!currentFilter) {
                // 필터가 없으면 모든 이벤트 표시
                filteredEvents = [...eventsData];
            } else {
                // 필터 적용
                filteredEvents = eventsData.filter(event => {
                    // 이벤트의 모든 텍스트 필드를 검색
                    return Object.values(event).some(value => {
                        if (value === null || value === undefined) return false;
                        if (value instanceof Date) return false;
                        return String(value).toLowerCase().includes(currentFilter);
                    });
                });
            }
            
            addDebugMessage(`필터 적용: "${currentFilter}" - ${filteredEvents.length}개 결과`);
            renderCalendar();
            
            // 통계 업데이트
            const filterStats = `<br><strong>현재 필터:</strong> ${currentFilter ? `"${currentFilter}" (${filteredEvents.length}개 표시)` : '없음'}`;
            const statsHtml = statsElement.innerHTML.split('<br><strong>현재 필터:')[0] + filterStats;
            statsElement.innerHTML = statsHtml;
        }
        
        // 엔터 키로 필터 적용
        filterInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                applyFilter();
            }
        });
        
        // 날짜 문자열 파싱 함수 (개선된 버전)
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // 이미 Date 객체인 경우
            if (dateStr instanceof Date) {
                return new Date(dateStr);
            }
            
            // 문자열로 변환
            let dateString = String(dateStr).trim();
            
            // 빈 문자열 체크
            if (dateString === '') {
                return null;
            }
            
            addDebugMessage(`날짜 파싱 시도: "${dateString}"`);
            
            // 일반적인 날짜 형식들 시도
            const formats = [
                'YYYY-MM-DD', 'YYYY/MM/DD', 'YYYY.MM.DD',
                'DD-MM-YYYY', 'DD/MM/YYYY', 'DD.MM.YYYY',
                'MM-DD-YYYY', 'MM/DD/YYYY', 'MM.DD.YYYY',
                'YY-MM-DD', 'YY/MM/DD', 'YY.MM.DD',
                'YYYYMMDD', 'DDMMYYYY', 'MMDDYYYY'
            ];
            
            for (const format of formats) {
                const date = moment(dateString, format, true); // strict parsing
                if (date.isValid()) {
                    addDebugMessage(`날짜 파싱 성공 (${format}): ${date.format('YYYY-MM-DD')}`);
                    return date.toDate();
                }
            }
            
            // 한국어 날짜 형식 (YYYY년 MM월 DD일)
            const koreanDatePattern = /(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일/;
            const koreanMatch = dateString.match(koreanDatePattern);
            if (koreanMatch) {
                const year = parseInt(koreanMatch[1]);
                const month = parseInt(koreanMatch[2]) - 1; // 0-based month
const day = parseInt(koreanMatch[3]);
                const date = new Date(year, month, day);
                
                if (!isNaN(date.getTime())) {
                    addDebugMessage(`한국어 날짜 형식 파싱 성공: ${date.toISOString().split('T')[0]}`);
                    return date;
                }
            }
            
            // 숫자만 있는 경우 (YYYYMMDD 형식)
            const numericPattern = /^(\d{4})(\d{2})(\d{2})$/;
            const numericMatch = dateString.match(numericPattern);
            if (numericMatch) {
                const year = parseInt(numericMatch[1]);
                const month = parseInt(numericMatch[2]) - 1; // 0-based month
                const day = parseInt(numericMatch[3]);
                const date = new Date(year, month, day);
                
                if (!isNaN(date.getTime())) {
                    addDebugMessage(`숫자 형식 날짜 파싱 성공: ${date.toISOString().split('T')[0]}`);
                    return date;
                }
            }
            
            // Excel 일련번호 시도 (1900-01-01 = 1)
            if (/^\d+(\.\d+)?$/.test(dateString)) {
                const excelDate = parseFloat(dateString);
                if (excelDate > 0) {
                    // Excel의 날짜 시스템 (1900-01-01 = 1)
                    // 주의: Excel의 버그로 1900년 2월 29일이 실제로 존재하지 않지만 포함됨
                    const date = new Date(Date.UTC(1899, 11, 30));
                    date.setDate(date.getDate() + excelDate);
                    
                    if (!isNaN(date.getTime())) {
                        addDebugMessage(`Excel 일련번호 날짜 파싱 성공: ${date.toISOString().split('T')[0]}`);
                        return date;
                    }
                }
            }
            
            // 모든 시도 실패
            addDebugMessage(`날짜 파싱 실패: "${dateString}"`);
            return null;
        }
        
        // CSV 파일 처리 함수
        function processCSVData(csvText) {
            showLoading(true);
            addDebugMessage("CSV 데이터 처리 시작");
            
            // 초기화
            eventsData = [];
            filteredEvents = [];
            totalRows = 0;
            successfulRows = 0;
            failedRows = 0;
            limitations = [];
            
            try {
                // Papa Parse로 CSV 파싱
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8",
                    transformHeader: function(header) {
                        // 헤더에서 BOM 제거 및 공백 제거
                        return header.replace(/^\uFEFF/, '').trim();
                    },
                    complete: function(results) {
                        addDebugMessage(`CSV 파싱 완료: ${results.data.length}행, ${results.meta.fields ? results.meta.fields.length : 0}열`);
                        
                        // 원본 데이터 저장
                        rawCSVData = results.data;
                        totalRows = results.data.length;
                        
                        // 헤더 정보 저장
                        columnHeaders = results.meta.fields || [];
                        addDebugMessage("헤더 목록: " + columnHeaders.join(", "));
                        
                        // 열 매핑 UI 업데이트
                        updateColumnMappingUI();
                        
                        // 이벤트 데이터 처리
                        processEventsData(results.data);
                        
                        // 통계 업데이트
                        updateStats();
                        
                        // 달력 렌더링
                        filteredEvents = [...eventsData];
                        renderCalendar();
                        
                        showLoading(false);
                    },
                    error: function(error) {
                        addDebugMessage("CSV 파싱 오류: " + error.message);
                        alert("CSV 파싱 중 오류가 발생했습니다: " + error.message);
                        showLoading(false);
                    }
                });
            } catch (error) {
                addDebugMessage("CSV 처리 예외 발생: " + error.message);
                alert("CSV 처리 중 오류가 발생했습니다: " + error.message);
                showLoading(false);
            }
        }
        
        // 이벤트 데이터 처리 함수
        function processEventsData(data) {
            eventsData = [];
            successfulRows = 0;
            failedRows = 0;
            limitations = [];
            
            addDebugMessage("이벤트 데이터 처리 시작");
            
            // 각 행 처리
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                
                try {
                    // 시작날짜 열 확인
                    const startDateValue = row[columnMapping.startDate];
                    if (!startDateValue) {
                        failedRows++;
                        limitations.push(`행 ${i+2}: 시작날짜가 비어있습니다.`);
                        continue;
                    }
                    
                    // 제목 열 확인
                    const titleValue = row[columnMapping.title];
                    if (!titleValue) {
                        failedRows++;
                        limitations.push(`행 ${i+2}: 행사제목이 비어있습니다.`);
                        continue;
                    }
                    
                    // 날짜 파싱
                    const startDate = parseDate(startDateValue);
                    if (!startDate) {
                        failedRows++;
                        limitations.push(`행 ${i+2}: 시작날짜 '${startDateValue}'를 파싱할 수 없습니다.`);
                        continue;
                    }
                    
                    // 종료날짜 파싱 (없으면 시작날짜와 같게 설정)
                    let endDate = null;
                    if (columnMapping.endDate && row[columnMapping.endDate]) {
                        endDate = parseDate(row[columnMapping.endDate]);
                    }
                    if (!endDate) {
                        endDate = new Date(startDate);
                    }
                    
                    // 이벤트 객체 생성
                    const event = {
                        title: titleValue,
                        startDate: startDate,
                        endDate: endDate,
                        content: columnMapping.content && row[columnMapping.content] ? row[columnMapping.content] : titleValue,
                        location: columnMapping.location && row[columnMapping.location] ? row[columnMapping.location] : '',
                        type: columnMapping.type && row[columnMapping.type] ? row[columnMapping.type] : '',
                        startTime: columnMapping.startTime && row[columnMapping.startTime] ? row[columnMapping.startTime] : '',
                        endTime: columnMapping.endTime && row[columnMapping.endTime] ? row[columnMapping.endTime] : '',
                        target: columnMapping.target && row[columnMapping.target] ? row[columnMapping.target] : '',
                        organization: columnMapping.organization && row[columnMapping.organization] ? row[columnMapping.organization] : '',
                        contact: columnMapping.contact && row[columnMapping.contact] ? row[columnMapping.contact] : ''
                    };
                    
                    // 이벤트 데이터에 추가
                    eventsData.push(event);
                    successfulRows++;
                    
                } catch (error) {
                    failedRows++;
                    limitations.push(`행 ${i+2}: 처리 중 오류 - ${error.message}`);
                    addDebugMessage(`행 ${i+2} 처리 오류: ${error.message}`);
                }
            }
            
            addDebugMessage(`이벤트 데이터 처리 완료: ${successfulRows}행 성공, ${failedRows}행 실패`);
        }
        
        // 파일 입력 이벤트 처리
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files.length > 0) {
                const file = this.files[0];
                fileName.textContent = file.name;
                
                addDebugMessage(`파일 선택됨: ${file.name} (${file.size} bytes)`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    processCSVData(e.target.result);
                };
                reader.onerror = function(e) {
                    addDebugMessage(`파일 읽기 오류: ${e.target.error}`);
                    alert('파일을 읽는 중 오류가 발생했습니다.');
                };
                reader.readAsText(file);
            }
        });
        
        // CSV 파일 로드 함수 (경로를 통한 로드)
        function loadCSVFile(filePath) {
            addDebugMessage(`CSV 파일 로드 시도: ${filePath}`);
            showLoading(true);
            
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP 오류 ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    fileName.textContent = filePath.split('/').pop();
                    processCSVData(csvText);
                })
                .catch(error => {
                    addDebugMessage(`파일 로드 오류: ${error.message}`);
                    statsElement.innerHTML = `CSV 파일 로드 실패: ${error.message}. <br>파일을 직접 선택해주세요.`;
                    showLoading(false);
                });
        }
        
        // 통계 정보 업데이트
        function updateStats() {
            let statsHTML = `<strong>파일 처리 결과:</strong> 총 ${totalRows}행 중 ${successfulRows}행 성공, ${failedRows}행 실패<br>`;
            statsHTML += `<strong>행사 정보:</strong> ${eventsData.length}개의 행사 로드됨`;
            
            if (limitations.length > 0) {
                statsHTML += '<br><strong>처리 제한사항:</strong><br>';
                
                // 최대 5개까지만 표시
                const displayLimit = Math.min(limitations.length, 5);
                for (let i = 0; i < displayLimit; i++) {
                    statsHTML += `- ${limitations[i]}<br>`;
                }
                
                if (limitations.length > displayLimit) {
                    statsHTML += `... 외 ${limitations.length - displayLimit}개 더 있음<br>`;
                }
                
                statsHTML += '<strong>해결 방법:</strong> 날짜 형식을 YYYY-MM-DD로 통일하거나, 열 매핑을 확인하세요.';
            }
            
            statsElement.innerHTML = statsHTML;
        }
        
        // 달력 렌더링 함수
        function renderCalendar() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            
            addDebugMessage(`달력 렌더링: ${year}년 ${month}월`);
            
            // 월의 첫날과 마지막날
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            // 첫 주의 시작 요일 (0: 일요일, 1: 월요일, ...)
            let startingDay = firstDay.getDay();
            // 월요일이 첫 날이 되도록 조정 (0:일->6, 1:월->0, ..., 6:토->5)
            startingDay = startingDay === 0 ? 6 : startingDay - 1;
            
            // 달력 테이블 생성
            let calendarHTML = `
                <table class="calendar">
                    <thead>
                        <tr>
                            <th>월</th>
                            <th>화</th>
                            <th>수</th>
                            <th>목</th>
                            <th>금</th>
                            <th class="saturday">토</th>
                            <th class="sunday">일</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let day = 1;
            const totalDays = lastDay.getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() + 1 === month;
            
            // 달력 행 생성
            for (let i = 0; i < 6; i++) {
                calendarHTML += '<tr>';
                
                // 달력 열 생성
                for (let j = 0; j < 7; j++) {
                    let cellClass = '';
                    
                    // 주말 클래스 추가
                    if (j === 5) cellClass += 'saturday ';
                    if (j === 6) cellClass += 'sunday ';
                    
                    // 첫 주이고 시작 요일보다 앞이거나, 이미 모든 날짜를 표시한 경우
                    if ((i === 0 && j < startingDay) || day > totalDays) {
                        calendarHTML += `<td class="${cellClass}"></td>`;
                    } else {
                        // 오늘 날짜인지 확인
                        if (isCurrentMonth && day === today.getDate()) {
                            cellClass += 'today ';
                        }
                        
                        // 현재 날짜의 이벤트 찾기
                        const currentDate = new Date(year, month - 1, day);
                        const dateEvents = filteredEvents.filter(event => {
                            return currentDate >= new Date(event.startDate.getFullYear(), event.startDate.getMonth(), event.startDate.getDate()) && 
                                  currentDate <= new Date(event.endDate.getFullYear(), event.endDate.getMonth(), event.endDate.getDate());
                        });
                        
                        calendarHTML += `<td class="${cellClass}">`;
                        calendarHTML += `<div class="date">${day}</div>`;
                        
                        if (dateEvents.length > 0) {
                            calendarHTML += '<div class="event-container">';
                            
                            // 최대 5개만 표시하고 나머지는 +N개 형식으로 표시
                            const displayLimit = 5;
                            for (let k = 0; k < Math.min(dateEvents.length, displayLimit); k++) {
                                const event = dateEvents[k];
                                let eventTypeClass = '';
                                
                                // 이벤트 유형에 따른 클래스 추가
                                if (event.type) {
                                    if (event.type.includes('공연')) eventTypeClass = 'event-type-공연';
                                    else if (event.type.includes('전시')) eventTypeClass = 'event-type-전시';
                                    else if (event.type.includes('체험')) eventTypeClass = 'event-type-체험';
                                    else if (event.type.includes('교육')) eventTypeClass = 'event-type-교육';
                                    else eventTypeClass = 'event-type-행사';
                                }
                                
                                calendarHTML += `
                                    <div class="event ${eventTypeClass}" data-event-index="${eventsData.indexOf(event)}">
                                        ${event.title}
                                    </div>
                                `;
                            }
                            
                            // 더 많은 이벤트가 있으면 표시
                            if (dateEvents.length > displayLimit) {
                                calendarHTML += `
                                    <div class="more-indicator">
                                        외 ${dateEvents.length - displayLimit}개 더...
                                    </div>
                                `;
                            }
                            
                            calendarHTML += '</div>';
                        }
                        
                        calendarHTML += '</td>';
                        day++;
                    }
                }
                
                calendarHTML += '</tr>';
                
                // 월의 모든 날짜를 표시했으면 반복 종료
                if (day > totalDays) {
                    break;
                }
            }
            
            calendarHTML += `
                    </tbody>
                </table>
            `;
            
            calendarContainer.innerHTML = calendarHTML;
            
            // 이벤트 클릭 리스너 추가
            document.querySelectorAll('.event').forEach(eventElement => {
                eventElement.addEventListener('click', function() {
                    const eventIndex = parseInt(this.getAttribute('data-event-index'));
                    showEventDetails(eventsData[eventIndex]);
                });
            });
        }
        
        // 이벤트 상세 정보 표시
        function showEventDetails(event) {
            addDebugMessage(`이벤트 상세 정보 표시: ${event.title}`);
            
            // 날짜 형식화
            const formatDate = date => {
                if (!date) return '';
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };
            
            // 이벤트 상세 정보 HTML 생성
            let detailsHTML = `
                <div class="event-title">${event.title}</div>
                
                <div class="event-detail">
                    <span class="event-label">시작날짜:</span> ${formatDate(event.startDate)}
                </div>
                
                <div class="event-detail">
                    <span class="event-label">종료날짜:</span> ${formatDate(event.endDate)}
                </div>
            `;
            
            // 시간 정보가 있으면 추가
            if (event.startTime) {
                detailsHTML += `
                    <div class="event-detail">
                        <span class="event-label">시작시간:</span> ${event.startTime}
                    </div>
                `;
            }
            
            if (event.endTime) {
                detailsHTML += `
                    <div class="event-detail">
                        <span class="event-label">종료시간:</span> ${event.endTime}
                    </div>
                `;
            }
            
            // 선택적 필드 추가
            const optionalFields = [
                { label: '장소', value: event.location },
                { label: '유형', value: event.type },
                { label: '대상', value: event.target },
                { label: '기관', value: event.organization },
                { label: '연락처', value: event.contact }
            ];
            
            for (const field of optionalFields) {
                if (field.value) {
                    detailsHTML += `
                        <div class="event-detail">
                            <span class="event-label">${field.label}:</span> ${field.value}
                        </div>
                    `;
                }
            }
            
            // 행사 내용이 있으면 추가
            if (event.content && event.content !== event.title) {
                detailsHTML += `
                    <div class="event-detail" style="margin-top: 10px;">
                        <span class="event-label" style="display: block; margin-bottom: 5px;">행사내용:</span>
                        <div style="white-space: pre-line;">${event.content}</div>
                    </div>
                `;
            }
            
            eventDetails.innerHTML = detailsHTML;
            eventModal.style.display = 'block';
        }
        
        // 로딩 인디케이터 표시/숨김
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>

